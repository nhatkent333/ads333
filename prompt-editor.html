<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt Editor — Two Pane</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --muted:#94a3b8;
      --var-bg:#2563eb; --file-bg:#ff0000; --cell-bg:#dc2626;
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#071024 0%, #071b2b 100%);color:#e6eef8}
    .wrap{height:100vh;display:grid;grid-template-rows:56px 1fr;gap:12px;padding:12px}
    header{display:flex;align-items:center;gap:12px}
    header h1{font-size:16px;margin:0}
    .container{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:stretch;height:100%}
    .panel{background:var(--panel);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);overflow:auto}
    .left textarea{width:100%;height:100%;min-height:0;border:0;background:transparent;color:inherit;resize:none;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;font-size:18px;line-height:1.5}
    .right{padding:16px}

    /* highlight styles */
    .tok-var{background:var(--var-bg);color:white;padding:2px 6px;border-radius:6px}
    .tok-file{background:var(--file-bg);color:black;padding:2px 6px;border-radius:6px}
    .tok-cell{background:var(--cell-bg);color:white;padding:2px 6px;border-radius:6px}

    /* lists */
    .right ul{padding-left:1.1rem;margin:6px 0}
    .right ol{padding-left:1.3rem;margin:6px 0}
    .right li{margin:4px 0}
    .right p, .right li { line-height: 1.8; }
    .right ul ul{padding-left:1.5rem}

    /* arrow */
    .arrow-line i {color: var(--muted); margin-right:6px;}

    /* small helper bar */
    .toolbar{margin-left:auto;display:flex;gap:8px}
    button{background:#0b1220;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
    button:active{transform:translateY(1px)}
    .hint{font-size:12px;color:var(--muted)}
    .status{font-size:12px;color:var(--muted);margin-left:12px}

    /* responsive */
    @media (max-width:900px){.container{grid-template-columns:1fr} .toolbar{display:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Prompt Editor — 2 khung (Plain text → Rich preview)</h1>
      <div class="toolbar">
        <button id="btn-clear">Xóa</button>
        <button id="btn-copy-markup">Copy plain</button>
        <button id="btn-copy-html">Copy HTML</button>
        <button id="btn-clear-store">Xóa store</button>
      </div>
      <div style="width:8px"></div>
      <div class="hint">Quy tắc: `backtick` → biến (xanh dương); [file] → file (xanh lá đậm); **tên** → cell (đỏ); dòng bắt đầu bằng "- " → bullet list; "-- " → bullet thụt vào; "->" → icon mũi tên; dòng bắt đầu bằng số → ordered list.</div>
      <div class="status" id="save-status">Đang sử dụng chế độ lưu tự động — chưa lưu</div>
    </header>

    <main class="container">
      <section class="panel left">
        <textarea id="editor" placeholder="Viết prompt ở đây...\nVí dụ:\n`user_name` lấy từ database\n[file.csv] là input\n**cell_1** chạy preprocessing\n- item A\n-- item A1\n-> bước kế tiếp\n1. step one\n2. step two"></textarea>
      </section>

      <section class="panel right">
        <div id="preview" class="right" aria-live="polite"></div>
      </section>
    </main>
  </div>

<script>
(function(){
  const STORAGE_KEY = 'prompt_editor_v1'
  const DAYS = 3000
  const EXPIRY_MS = DAYS * 24 * 60 * 60 * 1000 // 3000 days in ms

  const editor = document.getElementById('editor')
  const preview = document.getElementById('preview')
  const btnClear = document.getElementById('btn-clear')
  const btnCopyMarkup = document.getElementById('btn-copy-markup')
  const btnCopyHtml = document.getElementById('btn-copy-html')
  const btnClearStore = document.getElementById('btn-clear-store')
  const status = document.getElementById('save-status')

  let saveTimer = null

  function setStatus(text){ status.textContent = text }

  function escapeHtml(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  }

  function render(text){
    if(!text) { preview.innerHTML = '<div class="hint">Preview trống — nhập prompt bên trái.</div>'; return }

    const lines = text.replace(/\r\n/g,'\n').split('\n')
    let out = ''
    let i = 0
    while(i < lines.length){
      if(/^\s*\-\-\s+/.test(lines[i])){
        out += '<ul style="padding-left:2rem">'
        while(i < lines.length && /^\s*\-\-\s+/.test(lines[i])){
          const li = lines[i].replace(/^\s*\-\-\s+/, '')
          out += '<li>' + inlineTokens(li) + '</li>'
          i++
        }
        out += '</ul>'
        continue
      }

      if(/^\s*\-\>\s+/.test(lines[i])){
        out += '<p class="arrow-line"><i class="fa-solid fa-arrow-right"></i>' + inlineTokens(lines[i].replace(/^\s*\-\>\s+/, '')) + '</p>'
        i++
        continue
      }

      if(/^\s*\-\s+/.test(lines[i])){
        out += '<ul>'
        while(i < lines.length && /^\s*\-\s+/.test(lines[i])){
          const li = lines[i].replace(/^\s*\-\s+/, '')
          out += '<li>' + inlineTokens(li) + '</li>'
          i++
        }
        out += '</ul>'
        continue
      }

      if(/^\s*\d+[\.)]?\s+/.test(lines[i])){
        out += '<ol>'
        while(i < lines.length && /^\s*\d+[\.)]?\s+/.test(lines[i])){
          const li = lines[i].replace(/^\s*\d+[\.)]?\s+/, '')
          out += '<li>' + inlineTokens(li) + '</li>'
          i++
        }
        out += '</ol>'
        continue
      }

      if(lines[i].trim() === ''){
        out += '<div style="height:8px"></div>'
      } else {
        out += '<p style="margin:6px 0">' + inlineTokens(lines[i]) + '</p>'
      }
      i++
    }

    preview.innerHTML = out
  }

  function inlineTokens(s){
    let t = escapeHtml(s)
    t = t.replace(/\*\*([^*]+)\*\*/g, (_,g)=>`<span class="tok-cell">${g}</span>`)
    t = t.replace(/`([^`]+)`/g, (_,g)=>`<span class="tok-var">${g}</span>`)
    t = t.replace(/\[([^\]]+)\]/g, (_,g)=>`<span class="tok-file">${g}</span>`)
    return t
  }

  // Storage helpers (using localStorage so it works in any Chrome browser page)
  function saveToStore(value){
    try{
      const obj = { value, ts: Date.now() }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj))
      setStatus('Đã lưu tự động — ' + new Date(obj.ts).toLocaleString())
    }catch(e){
      setStatus('Lỗi khi lưu: ' + e.message)
    }
  }

  function loadFromStore(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY)
      if(!raw) return null
      const obj = JSON.parse(raw)
      if(!obj || !obj.ts) return null
      if(Date.now() - obj.ts > EXPIRY_MS){
        // expired
        localStorage.removeItem(STORAGE_KEY)
        return null
      }
      return obj.value
    }catch(e){
      console.error('loadFromStore', e)
      return null
    }
  }

  function clearStore(){
    try{ localStorage.removeItem(STORAGE_KEY); setStatus('Đã xóa store') }catch(e){ setStatus('Không xóa được: '+e.message) }
  }

  // debounce save
  function scheduleSave(){
    if(saveTimer) clearTimeout(saveTimer)
    saveTimer = setTimeout(()=>{
      saveToStore(editor.value)
    }, 600)
  }

  // events
  editor.addEventListener('input', ()=>{ render(editor.value); scheduleSave() })
  editor.addEventListener('keydown', (e)=>{
    if(e.key === 'Tab'){
      e.preventDefault()
      const el = e.target
      const start = el.selectionStart
      const end = el.selectionEnd
      const val = el.value
      el.value = val.slice(0,start) + '  ' + val.slice(end)
      el.selectionStart = el.selectionEnd = start + 2
      render(el.value)
      scheduleSave()
    }
  })

  btnClear.addEventListener('click', ()=>{ editor.value = ''; render(''); scheduleSave() })
  btnCopyMarkup.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(editor.value); alert('Đã copy plain text') }catch(e){ alert('Không copy được: '+e) }
  })
  btnCopyHtml.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(preview.innerHTML); alert('Đã copy HTML của preview') }catch(e){ alert('Không copy được: '+e) }
  })
  btnClearStore.addEventListener('click', ()=>{ if(confirm('Xóa dữ liệu lưu trữ local của ứng dụng?')) clearStore() })

  // save on unload
  window.addEventListener('beforeunload', ()=>{
    try{ saveToStore(editor.value) }catch(e){}
  })

  // init: try to load from store (if not expired)
  const stored = loadFromStore()
  const demo = "`user_name` lấy từ DB\n[file.csv] — input chính\n**cell_preprocess** chạy trước\n\n- loạt cấu hình\n-- bật chế độ debug\n-> chạy kế tiếp\n1. bước đầu\n2. bước tiếp theo\n\nMột dòng có `var` và [file.txt] cùng lúc và **cellX**."
  if(stored !== null && stored !== undefined){
    editor.value = stored
    setStatus('Đã khôi phục nội dung lưu — ' + new Date().toLocaleString())
  } else {
    editor.value = demo
    setStatus('Sử dụng nội dung mẫu — chưa có dữ liệu lưu')
  }

  render(editor.value)
  // also save initial content so expiry counts from first save
  scheduleSave()
})()
</script>
</body>
</html>
